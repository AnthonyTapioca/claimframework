<script>
let orders = [];

async function fetchOrders() {
  const email = document.getElementById('email').value.trim();
  if (!email) return alert('Enter email');

  const res = await fetch('/api', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email, fetchOnly: true })
  });

  const data = await res.json();
  if (!res.ok) return alert(data.error || 'No orders');

  orders = data.orders;

  const select = document.getElementById('orderSelect');
  select.innerHTML = '';
  orders.forEach((o, i) => {
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = `${o.name} â€” ${new Date(o.created_at).toLocaleDateString()}`;
    select.appendChild(opt);
  });

  select.classList.remove('hidden');
  document.getElementById('redeemBtn').classList.remove('hidden');
}

async function redeemOrder() {
  const email = document.getElementById('email').value.trim();
  const idx = document.getElementById('orderSelect').value;
  const order = orders[idx];
  if (!order) return;

  const res = await fetch('/api', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email, orderId: order.name, source: 'frontend' })
  });

  const data = await res.json();
  if (!res.ok) return alert(data.error);

  window.location.href = '/api?discordLogin=true';
}
</script>
